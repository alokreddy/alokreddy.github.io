<!DOCTYPE html>
<html>
<head>
<title>HR Dashboard</title>
<meta charset="UTF-8">
<meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>
<link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.4/dc.min.css" rel="stylesheet"/>
<link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet">
<link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/css/jquery.dataTables.min.css" rel="stylesheet">
<link type="text/css" src="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" rel="stylesheet">
<style>

    h4 {
      font-size:14px;
      font-weight:bold;
	  float: left;
	  text-align: bottom;

      }

    a {
      font-size:12px;
      font-weight:normal;
      }
    
	.heat-box {
        stroke: #E6E6E6;
        stroke-width: 2px;
      }
	  
	h3 {
      text-align: center;
	  color : #1f1484;
    }

    
	h2 span {
      font-size:14px;
      font-weight:normal;
	  text-align: center;
      }
	  
	.dc-table-chart {
		width:100%;
	}
	
	div.container {
        width: 100%;
    }
	
	.dc-chart g.row text {
	  fill: black;
	  font-size: 10px;
	}
	
	label {
	  font: bold 12px sans-serif;
	}
	
	.heat-box {
        stroke: #E6E6E6;
        stroke-width: 2px;
      }
	  
	.numberbox {
        background: #032866;
		color: white;
        width: 290px;
        font-size: 30px;
        text-align: center;
        vertical-align: middle;
        padding-top: 16px;
        padding-bottom: 83px;
        height: 160px;
        line-height: normal;
		margin: 10px;
      }
	  
	  .sidenav .dc-select-menu {
      background-color: #032866;
	  color: white;
	  width: 240px;
    }
	
	.topcorner{
	   position:absolute;
	   top:16px;
	   right:11px;
	}

.dc-chart .axis line, .dc-chart .axis path ,tick{
    fill: none;
    shape-rendering: crispedges;
    stroke: #cac2c2;
}

.dc-chart g.axis text {
	fill: #696262;
}
	  
</style>
</head>
<body>
<div class="topcorner">Data as on 01-May-2017<br><a>Total Records: 17,907</a></div>

<div class='container' id='main-container'>
<div class='content'>
<div class='container' style='font: 12px sans-serif;'>
	<div class = 'row'>
		<div class="col-10 dc-data-count" style = 'float:right;'>
			<h2>HR Dashboard
			  <span>
				<span class="filter-count"></span>
				 selected out of 
				<span class="total-count"></span>
				 records 
			  </span>
			</h2>
		</div>
	</div>
	
	<div class = 'col-2 sidenav'>
	
		<div id = 'selectPayrollCountry'>
			
			<div>
				
				<h4> Country
					<a class = 'reset'
					href = 'javascript:selectPayrollCountry.filterAll();dc.redrawAll();'
					style = 'visibility: hidden;'>reset</a>
				</h4>
				
			</div>
			
		</div>
		
		<div id = 'selectBRC'>
			
			<div>

				<h4> BRC
				<a class = 'reset'
					href = 'javascript:selectBRC.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			
			</div>
		
		</div>
		
		<div id = 'selectBRC1'>
		
			<div>
				<h4> BRC-1
					<a class = 'reset'
					href = 'javascript:selectBRC1.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>

		<div id = 'selectBRC2'>
		
			<div>
				<h4> BRC-2
					<a class = 'reset'
					href = 'javascript:selectBRC2.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>
		</div>

		<div id = 'selectSBU'>
		
			<div>
				<h4> SBU
					<a class = 'reset'
					href = 'javascript:selectSBU.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>

		<div id = 'selectServLine'>
		
			<div>
				<h4> Service Line
					<a class = 'reset'
					href = 'javascript:selectServLine.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>

		<div id = 'selectCostCntr'>
		
			<div>
				<h4> Cost Center
					<a class = 'reset'
					href = 'javascript:selectCostCntr.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>
		
		<div id = 'selectJobFamily'>
		
			<div>
				<h4> Job Family
					<a class = 'reset'
					href = 'javascript:selectJobFamily.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>
		
		<div id = 'selectSupervisorJT'>
		
			<div>
				<h4> Supervisor Job Title
					<a class = 'reset'
					href = 'javascript:selectSupervisorJT.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>

		<div id = 'selectEmpJT'>
		
			<div>
				<h4> Employee Job Title
					<a class = 'reset'
					href = 'javascript:selectEmpJT.filterAll();dc.redrawAll()'
					style = 'visibility:hidden;'>reset</a>
				</h4>
			</div>

		</div>

		
	</div>
	
	
	
	<div class = 'row'>
		<span>
			<div class='col-lg-6 numberbox' id = 'dc-number-box-annualsal'>
			<h2>
			Annual Salary FTE<br><a>(Sum in USD)</a></h2>
				<span>
					<a class="reset"
					href="javascript:boxNDannualsal.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		
		<div class='col-lg-6 numberbox' id = 'dc-number-box-compratio'>
			<h2>
			Comp Ratio<br><a>(Avg)</a>
				<span>
					<a class="reset"
					href="javascript:boxNDcompratio.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
			</h2>
		</div>
			<div class='col-lg-6 numberbox' id = 'dc-number-box-emphc'>
			<h2>
			Employee <br>Head Count</h2>
				<span>
					<a class="reset"
					href="javascript:boxNDannualsal.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		
	<!-- 	<div class='col-lg-6 numberbox' id = 'dc-number-box-market'>
			<h3>
			Avg<br>Market Median </h3>
				<span>
					<a class="reset"
					href="javascript:boxNDcompratio.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>-->

	 <div class='col-lg-6 numberbox' id = 'dc-number-box-cost'>
			<h2>
			Cost to<br>Market Median<a>(USD)</a></h2>
				<span>
					<a class="reset"
					href="javascript:boxNDmarketcost.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		</span>
	</div>
	 
	<div class = 'row'>
		
		<div class='col-6' id = 'dc-bubble-chart'>
			<h3> Payroll Cost and Employee Head Count by Career Level </h3>
			<p style="text-indent: 40px">*Bubble size indicates avg. payroll cost</p>
			<a class = 'reset'
			href = 'javascript:bubbleChart.filterAll();dc.redrawAll();'
			style='display:none;'>
			reset
			</a>
		</div>
		
		<div class='col-6' id = 'dc-heat-chart'>
			<h3>Average Comp Ratio for BRC Members by Career Level
			<a class = 'reset'
			href = 'javascript:heatChart.filterAll();dc.redrawAll();'
			style='display:none;'>
			reset
			</a></h3>
		</div>
	
	</div>
	
	<!--<div class = 'row'>
		<span>
			<div class='col-lg-3' id = 'dc-pie-clchart'>
			<h3>
			Career Band
			</h3>
				<span>
					<a class="reset"
					href="javascript:clChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		<div class='col-lg-3' id = 'dc-pie-pmd15chart'>
			<h3>
			PMD FY15
			</h3>
				<span>
					<a class="reset"
					href="javascript:pmd15Chart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		<div class='col-lg-3' id = 'dc-pie-pmd16chart'>
			<h3>
			PMD FY16
			</h3>
				<span>
					<a class="reset"
					href="javascript:pmd16Chart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
	<div class='col-lg-3' id = 'dc-pie-chart'>
			<h3>
			Comp Ratio
			</h3>
				<span>
					<a class="reset"
					href="javascript:pieChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
		</div>
		</span>
	</div>-->
	
	<div class = 'row'>
	<div class = 'row'>
		<span>
			<div class='col-4' id = 'dc-bar-clEchart'>
			<h3>Executive</h3>
				<span>
					<a class="reset"
					href="javascript:clEbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
			<div class='col-4' id = 'dc-bar-clMchart'>
			<h3>Management</h3>
				<span>
					<a class="reset"
					href="javascript:clMbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
			<div class='col-4' id = 'dc-bar-clTchart'>
			<h3>Scientific</h3>
				<span>
					<a class="reset"
					href="javascript:clTbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
		</span>
		</div>
		<div class = 'row'>
		<span>
			<div class='col-4' id = 'dc-bar-clPchart'>
			<h3>Professional</h3>
				<span>
					<a class="reset"
					href="javascript:clPbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
			<div class='col-4' id = 'dc-bar-clSchart'>
			<h3>Sales</h3>
				<span>
					<a class="reset"
					href="javascript:clSbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
		<div class='col-4' id = 'dc-bar-clUchart'>
			<h3>Support</h3>
				<span>
					<a class="reset"
					href="javascript:clUbarChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
				</span>
				
		</div>
		</span>
		</div>
		</div>
		
	
	<div class="container"  style="margin-left:240px;width:auto">
	<div class = 'row'>
		<div class='col-4' id = 'dc-bar-pmd15chart'>
			<h3>FY15 PMD Rating Distribution</h3>
					<a class="reset"
					href="javascript:pmd15barChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
		</div>
		<div class='col-4' id = 'dc-bar-pmd16chart'>
			<h3>FY16 PMD Rating Distribution</h3>
					<a class="reset"
					href="javascript:pmd16barChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
		</div>
	<div class='col-4' id = 'dc-bar-chart'>
			<h3>Position in Range Distribution</h3>
					<a class="reset"
					href="javascript:barChart.filterAll();dc.redrawAll();"
					style="display: none;">
					reset
					</a>
		</div>
	</div>
	</div>
	
	<div class='row'>
		<div class='col-xs-12'>
			<h3>Market Data Table</h3>
				<table class='table table-hover' id='dc-table-chart' style="width: 100%; margin: 0 auto 2em auto;" cellpadding="3" cellspacing="0" border="0">
					<thead>
						<tr class='header'>
							<th>Employee Name</th>
							<th>Market Title</th>
							<th>Annual Salary</th>
							<th>CompRatio</th>
							<th>Payroll Country</th>
							<th>Supervisor Full Name</th>
							<th>SBU</th>
						</tr>
					</thead>
				</table>
		</div>
	</div>
  
</div>
</div>
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.3/dc.js"></script>
<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/js/jquery.dataTables.min.js'></script>
<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.min.js'></script>
<script src = "https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
<!--<script src = "https://cdn.rawgit.com/bpampuch/pdfmake/0.1.24/build/pdfmake.min.js"></script>
<script src = "https://cdn.rawgit.com/bpampuch/pdfmake/0.1.24/build/vfs_fonts.js"></script>-->
<script src = "https://cdn.datatables.net/buttons/1.2.4/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>
<script type="text/javascript">

//connect charts to their appropriate selectors
//var mapChart = dc_leaflet.markerChart("#dc-map-chart");
var selectPayrollCountry = dc.selectMenu('#selectPayrollCountry'),
	selectBRC = dc.selectMenu('#selectBRC'),
	selectBRC1 = dc.selectMenu('#selectBRC1'),
	selectBRC2 = dc.selectMenu('#selectBRC2'),
	selectSBU = dc.selectMenu('#selectSBU'),
	selectServLine = dc.selectMenu('#selectServLine'),
	selectCostCntr = dc.selectMenu('#selectCostCntr'),
	selectJobFamily = dc.selectMenu('#selectJobFamily'),
	selectSupervisorJT = dc.selectMenu('#selectSupervisorJT'),
	selectEmpJT = dc.selectMenu('#selectEmpJT'),
	boxNDannualsal    = dc.numberDisplay("#dc-number-box-annualsal"),
	boxNDcompratio    = dc.numberDisplay("#dc-number-box-compratio"),
	boxNDempcount    = dc.numberDisplay("#dc-number-box-emphc"),
	//var boxNDmarketmed    = dc.numberDisplay("#dc-number-box-market");
	boxNDmarketcost    = dc.numberDisplay("#dc-number-box-cost"),
	bubbleChart    = dc.bubbleChart("#dc-bubble-chart"),
	heatChart    = dc.heatMap("#dc-heat-chart"),
	clChart = dc.pieChart("#dc-pie-clchart"),
	pmd15Chart = dc.pieChart("#dc-pie-pmd15chart"),
	pmd16Chart = dc.pieChart("#dc-pie-pmd16chart"),
	pieChart = dc.pieChart("#dc-pie-chart"),
	clEbarChart = dc.barChart("#dc-bar-clEchart"),
	clMbarChart = dc.barChart("#dc-bar-clMchart"),
	clTbarChart = dc.barChart("#dc-bar-clTchart"),
	clPbarChart = dc.barChart("#dc-bar-clPchart"),
	clSbarChart = dc.barChart("#dc-bar-clSchart"),
	clUbarChart = dc.barChart("#dc-bar-clUchart"),
	pmd15barChart = dc.barChart("#dc-bar-pmd15chart"),
	pmd16barChart = dc.barChart("#dc-bar-pmd16chart"),
	barChart = dc.barChart("#dc-bar-chart"),
	dataCount = dc.dataCount(".dc-data-count"),
	datatable = $('#dc-table-chart');
//var select1 = dc.selectMenu('#select1');
//var numberFormat = d3.format(".2f");

d3.csv("Master Benchmark File.csv", function(error, data) {
    data.forEach(function(d) {
		//d['Employee Name'] = d['Employee Name'];
		d['SBU'] = d['SBU'];
		//d.ServiceLine = d['Service Line'];
		//console.log(d.ServiceLine);
		//d['Payroll Country'] = d['Payroll Country'] ? d['Payroll Country'] : "MISSING";
		d['Supervisor Full Name'] = d['Supervisor Full Name'] ? d['Supervisor Full Name'] : "MISSING";
		//d['Market Title'] = d['Market Title'] ? d['Market Title'] : "MISSING";	
		d['Annual Salary'] = +d['Annual Salary'];//? d['Market Median'] : "MISSING";
		d['Market Median'] = d['Market Median'];//? d['Market Median'] : "MISSING";
		d['CompRatio'] = d['CompRatio'];
		//d['PID'] = d['PID'];
		//d['PID Count'] = d['PID Count']? d['PID Count'] : 0;
	//toplevel crossfilter
	});
	var xf = crossfilter(data);
	
	//console.log(data[0]);
var numberFormat = d3.format(".2f"),	
	numberFormat2 = d3.format(".2s"),
    formatBillion = function(x) { return numberFormat(x / 1e9) + "B"; },
    formatMillion = function(x) { return numberFormat(x / 1e6) + "M"; },
    formatThousand = function(x) { return numberFormat(x / 1e3) + "k"; };

function formatAbbreviation(x) {
  var v = Math.abs(x);
  return (v >= .9995e9 ? formatBillion
      : v >= .9995e6 ? formatMillion
      : formatThousand)(x);
}

	//counter
	var all = xf.groupAll();
	dataCount.dimension(xf)
		.group(all);
	
	  var posinrangeDimension  = xf.dimension(function(d) {return d['Position In Range'];}),
			salSumGroup = posinrangeDimension.group().reduceCount();

var brcDim = xf.dimension(function(d){return d['BRC'];}),
	brc1Dim = xf.dimension(function(d){return d['BRC-1'];}),
	brc2Dim = xf.dimension(function(d){return d['BRC-2'];}),
	sbuDim = xf.dimension(function(d) { return d['SBU']; }),
	sbuDimGroup = sbuDim.group(),
	payrollDim = xf.dimension(function(d) {return d['Payroll Country'];}),
	servLineDim = xf.dimension(function(d) {return d['Service Line'];}),
	costCntrDim = xf.dimension(function(d) {return d['Cost Center'];}),
	jobFamilyDim = xf.dimension(function(d) {return d['JobFamilyDescription'];}),
	supervisorJobTitleDim = xf.dimension(function(d) {return d['SupervisorJobTitle'];}),
	empJobTitleDim = xf.dimension(function(d) {return d['Market Title'];}),
	pmd15Dim = xf.dimension(function(d) {return d['FY15 PMD Rating'];}),
	pmd16Dim = xf.dimension(function(d) {return d['FY16 PMD Rating'];}),
	careerBandDim = xf.dimension(function(d) {return d['Career Band2'];}),
	careerLevelDim = xf.dimension(function (d) {return d['Career Level'];}),
	executiveDim = xf.dimension(function (d) {return d['VP Criteria'];}),
	managementDim = xf.dimension(function (d) {return d['Management'];}),
	scientificDim = xf.dimension(function (d) {return d['Scientific / Technical'];}),
	professionalDim = xf.dimension(function (d) {return d['Professional'];}),
	salesDim = xf.dimension(function (d) {return d['Sales'];}),
	supportDim = xf.dimension(function (d) {return d['Support'];}),
	salArrayGroup     = careerLevelDim.group().reduce(
        function(p,v) {
          p.push(v['Annual Salary FTE (USD)']);
          return p;
        },
        function(p,v) {
          p.splice(p.indexOf(v['Annual Salary FTE (USD)']), 1);
          return p;
        },
        function() {
          return [];
        }
      );
	  
          	  
//select menu
selectPayrollCountry
		.dimension(payrollDim)
		.multiple(true)
		.numberVisible(10)
		.group(payrollDim.group())
		.controlsUseVisibility(true);
		
selectBRC
	.dimension(brcDim)
	.group(brcDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);
				

selectBRC1
	.dimension(brc1Dim)
	.group(brc1Dim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);

selectBRC2
	.dimension(brc2Dim)
	.group(brc2Dim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);
	
selectSBU
	.dimension(sbuDim)
	.group(sbuDim.group())
	.multiple(true)
	.numberVisible(7)
	.controlsUseVisibility(true);

selectServLine
	.dimension(servLineDim)
	.group(servLineDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);

selectCostCntr
	.dimension(costCntrDim)
	.group(costCntrDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);

selectJobFamily
	.dimension(jobFamilyDim)
	.group(jobFamilyDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);

selectSupervisorJT
	.dimension(supervisorJobTitleDim)
	.group(supervisorJobTitleDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);

selectEmpJT
	.dimension(empJobTitleDim)
	.group(empJobTitleDim.group())
	.multiple(true)
	.numberVisible(10)
	.controlsUseVisibility(true);
	
//heatChart
	
     var clBRCDim = xf.dimension(function(d) { return [d['Career Level'], d['BRC']]; });

var clBRCGroup = clBRCDim.group().reduce(
                function (p, v) {
                    p.tot += +v["CompRatio"];
					if (p.tot < 0.001) p.tot = 0;
                    p.n ++;
					p.avg = p.tot / p.n;
                    return p;
                },
                function (p, v) {
                    p.tot -= +v["CompRatio"];
					if (p.tot < 0.001) p.tot = 0; 
                    p.n --;
					p.avg = p.n ? p.tot / p.n : 0;
                    return p;
                },
                function () {
                    return {tot: 0, n: 0, avg: 0}
                }
        );
		
function remove_empty_bins(source_group) {
    return {
        all:function () {
            return source_group.all().filter(function(d) {
                return d.value.n != 0;
            });
        }
    };
}

var filtered_group = remove_empty_bins(clBRCGroup);		
	  
  heatChart
    .width(45 * 12 + 160)
    .height(45 * 7 + 60)
	.margins({top: 10, right: 50, bottom: 30, left: 90})
    .dimension(clBRCDim)
    .group(filtered_group)
    .keyAccessor(function(d) { return d.key[0]; })
    .valueAccessor(function(d) { return d.key[1]; })
    .colorAccessor(function(d) { return +d.value.avg; })
    .title(function(d) {
        return "Career Level:   " + d.key[0] + "\n" +
               "BRC Member:  " + d.key[1] + "\n" +
               "Emp. Count:  " + d.value.n + "\n" +
               "CompRatio: " + numberFormat(d.value.avg);})
    .colors(d3.scale.quantize()
			.domain([0.80, 0.94999, 1.04999, 1.1999, 1.35])
			.range(["red", "orange", "green", "cyan", "blue"]));
	/*.calculateColorDomain()
	.on('preRedraw', function() {
        heatChart.calculateColorDomain();
    });*/

//bubbleChart

var careerLevelGroup = careerLevelDim.group().reduce(
                function (p, v) {
                    p.tot += +v["Annual Salary FTE (USD)"]/1000000;
					if (p.tot < 0.001) p.tot = 0;
                    p.n ++;
					p.avg = p.tot / p.n;
                    return p;
                },
                function (p, v) {
                    p.tot -= +v["Annual Salary FTE (USD)"]/1000000;
					if (p.tot < 0.001) p.tot = 0; 
                    p.n --;
					p.avg = p.n ? p.tot / p.n : 0;
                    return p;
                },
                function () {
                    return {tot: 0, n: 0, avg: 0}
                }
        );
		
		var average_annualsal = function(d) {
				return d.n > 0 ? d.tot / d.n : 0;
			};
			
		var expCount_annualsal = function(d) {
				return d.n;
			};

bubbleChart
	.width(600)
	.height(360)
	.margins({top: 10, right: 20, bottom: 30, left: 35})
	.dimension(careerLevelDim)
	.group(careerLevelGroup)
	.colors(d3.scale.category10())
	.keyAccessor(function (p){
		return p.value.tot;
	})
	.valueAccessor(function(p){
		return p.value.n;
	})
	.radiusValueAccessor(function(p){
		return p.value.avg;
	})
	.x(d3.scale.linear().domain([0, 400]))
	.y(d3.scale.linear().domain([0, 10000]))
	.r(d3.scale.linear().domain([0, 400]))
	.minRadiusWithLabel(10)
	.elasticY(true)
	.yAxisPadding(440)
	.elasticX(true)
	.xAxisPadding(10)
	.maxBubbleRelativeSize(45)
	.renderHorizontalGridLines(true)
    .renderVerticalGridLines(true)
	.renderLabel(true)
	.yAxisLabel('Employee Count')
	.xAxisLabel('Sum of Payroll Cost')
	.renderTitle(true)
	.title(function (p) {
                        return p.key
                                + "\n"
                                + "Sal Sum USD: " + numberFormat(p.value.tot) + "M\n"
                                + "Sal Avg USD: " + numberFormat2(p.value.avg*1000000) + "\n"
                                + "Number of Emps: " + (p.value.n);
                    });
					
	bubbleChart.yAxis().tickFormat(function (s) {
                return s + "";
            });
    bubbleChart.xAxis().tickFormat(function (s) {
                return s + "M";
            });

//barChart
var careerBandGroup = careerBandDim.group().reduceCount();

function remove_bins(source_group) { // 
  return {
    all: function() {
      
      return source_group.all().filter(function(d) {
        console.log(d)
        return d.key != "";
      });
    }
  };
}

var filtered_groupE = remove_bins(executiveDim.group().reduceCount());

clEbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#FFD700')
	.brushOn(true)
	.xAxisLabel('Career Level')
	.yAxisLabel('Emp Count')
	.dimension(executiveDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupE);

	
var filtered_groupM = remove_bins(managementDim.group().reduceCount());
	
clMbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#B8CCE4')
	.brushOn(true)
	.xAxisLabel('Career Level')
//	.yAxisLabel('Emp Count')
	.dimension(managementDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupM);

var filtered_groupT = remove_bins(scientificDim.group().reduceCount());
	
clTbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#DDD9C4')
	.brushOn(true)
	.xAxisLabel('Career Level')
//	.yAxisLabel('Emp Count')
	.dimension(scientificDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupT);

var filtered_groupP = remove_bins(professionalDim.group().reduceCount());
	
clPbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#E4DFEC')
	.brushOn(true)
	.xAxisLabel('Career Level')
	.yAxisLabel('Emp Count')
	.dimension(professionalDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupP);

var filtered_groupS = remove_bins(salesDim.group().reduceCount());
	
clSbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#40E0D0')
	.brushOn(true)
	.xAxisLabel('Career Level')
//	.yAxisLabel('Emp Count')
	.dimension(salesDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupS);

var filtered_groupU = remove_bins(supportDim.group().reduceCount())	

clUbarChart
	.width(440)
	.height(280)
	.margins({top: 10, right: 70, bottom: 30, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticX(true)
	.elasticY(true)
	.colors('#D8E4BC')
	.brushOn(true)
	.xAxisLabel('Career Level')
//	.yAxisLabel('Emp Count')
	.dimension(supportDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(filtered_groupU);

	
pmd15barChart
	.width(440)
	.height(320)
	.margins({top: 10, right: 50, bottom: 90, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.brushOn(true)
	.elasticY(true)
	.elasticX(true)
	.colors('#04849b')
	//.xAxisLabel('FY15 Rating')
	.yAxisLabel('Emp Count')
	.dimension(pmd15Dim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(pmd15Dim.group());	
//	.ordering(function(d) { return -d.value; });

pmd15barChart.renderlet(function(chart) {
          // rotate x-axis labels
          chart.selectAll('g.x text')
          .attr('transform', 'translate(-30,30) rotate(315)');
        });
      
pmd16barChart
	.width(440)
	.height(320)
	.margins({top: 10, right: 50, bottom: 90, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticY(true)
	.elasticX(true)
	.colors('#04849b')
	.brushOn(true)
	//.xAxisLabel('FY16 Rating')
	.dimension(pmd16Dim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(pmd16Dim.group());
//	.ordering(function(d) { return -d.value; });

pmd16barChart.renderlet(function(chart) {
          // rotate x-axis labels
          chart.selectAll('g.x text')
          .attr('transform', 'translate(-30, 30) rotate(315)');
        });

	
barChart
	.width(440)
	.height(320)
	.margins({top: 10, right: 50, bottom: 90, left: 60})
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.elasticY(true)
	.elasticX(true)
	.colors('#04849b')
	.brushOn(true)
	//.xAxisLabel('Position in Range')
	.dimension(posinrangeDimension)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(salSumGroup);
//	.ordering(function(d) { return -d.value; });

barChart.renderlet(function(chart) {
          // rotate x-axis labels
          chart.selectAll('g.x text')
          .attr('transform', 'translate(-20, 20) rotate(315)');
        });

clChart
	.height(280)
	.width(280)
	.slicesCap(6)
    .innerRadius(80)
	.dimension(careerBandDim)
	.group(careerBandGroup)
	.colors('#04849b')
	/*.on('pretransition', function(chart) {
        chart.selectAll('text.pie-slice').text(function(d) {
            return [d.data.key, dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%'].join('\r\n');
        })
    });*/
	//.valueAccessor(function (p) {
		//	return p.value.n;
		//})//careerLevelDim.group().reduceCount())	

//pieChart
  pieChart
    .width(280)
    .height(280)
    .slicesCap(6)
    .innerRadius(80)
    .dimension(posinrangeDimension)
    .group(salSumGroup)
    .legend(dc.legend().x(400).y(0).gap(5))
	.renderLabel(true)
	.on('pretransition', function(chart) {
        chart.selectAll('text.pie-slice').text(function(d) {
            return [dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%'].join('\r\n');
        })
    });
//pieChart
  pmd15Chart
    .width(280)
    .height(280)
    .slicesCap(6)
    .innerRadius(80)
    .dimension(pmd15Dim)
    .group(pmd15Dim.group())
    .legend(dc.legend().x(400).y(0).gap(5))
	.renderLabel(true)
	.on('pretransition', function(chart) {
        chart.selectAll('text.pie-slice').text(function(d) {
            return [d.data.key.slice(0,1), ' - ',dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%'].join('\r\n');
        })
    });
//pieChart
  pmd16Chart
    .width(280)
    .height(280)
    .slicesCap(6)
    .innerRadius(80)
    .dimension(pmd16Dim)
    .group(pmd16Dim.group())
    .legend(dc.legend().x(400).y(0).gap(5))
	.renderLabel(true)
	.on('pretransition', function(chart) {
        chart.selectAll('text.pie-slice').text(function(d) {
            return [d.data.key.slice(0,1), ' - ',dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%'].join('\r\n');
        })
    });
	
	

	
	//table
	//dimension for table search
	var tableDimension = xf.dimension(function (d) { return d['SBU'].toLowerCase() + ' ' +
															d['Payroll Country'].toLowerCase() + ' ' +
															d['Supervisor Full Name'].toLowerCase() + ' ' +
															d['Employee Name'].toLowerCase() + ' ' +
															d['Market Title'].toLowerCase();});
			
	//set options and columns
	var dataTableOptions = {
        "bSort": true,
		columnDefs: [
			{
				targets: 0,
				data: function (d) { return d['Employee Name'];},
				//type: 'date',
				defaultContent: 'Not found'
			},
			{
				targets: 1,
				data: function (d) { return d['Market Title'];},
				defaultContent: ''
			},
			{
				targets: 2,
				data: function (d) { return d['Annual Salary FTE (USD)'];},
				render: $.fn.dataTable.render.number( ',', '.'),
				defaultContent: ''
			},
			{
				targets: 3,
				data: function (d) { return d['CompRatio'];},
				render: $.fn.dataTable.render.number( ',', '.', 2),
				defaultContent: ''
			},
			{
				targets: 4,
				data: function (d) { return d['Payroll Country'];},
				defaultContent: ''
			},
			{
				targets: 5,
				data: function (d) {return d['Supervisor Full Name'];},
				defaultContent: ''
			},
			{
				targets: 6, //search column
				data: function (d) {return d['SBU'];},
				defaultContent: 'Not Found',
				visible: false
			}
		],
        dom: 'Bfrtip',
        buttons: [
            $.extend( true, {}, buttonCommon, {
                extend: 'copyHtml5'
            } ),
            $.extend( true, {}, buttonCommon, {
                extend: 'excelHtml5'
            } ),
            $.extend( true, {}, buttonCommon, {
                extend: 'pdfHtml5'
            } )
        ]
	};
	
	//initialize datatable
	datatable.dataTable(dataTableOptions);
	
function filterGlobal () {
    $('#dc-table-chart').DataTable().search(
        $('#global_filter').val(),
        $('#global_regex').prop('checked'),
        $('#global_smart').prop('checked')
    ).draw();
}

function filterColumn ( i ) {
    $('#dc-table-chart').DataTable().column( i ).search(
        $('#col'+i+'_filter').val(),
        $('#col'+i+'_regex').prop('checked'),
        $('#col'+i+'_smart').prop('checked')
    ).draw();
}

var buttonCommon = {
        exportOptions: {
            format: {
                body: function ( data, row, column, node ) {
                    // Strip $ from salary column to make it numeric
                    return data;
                }
            }
        }
    };
 

 
$(document).ready(function() {
	    

    $('#dc-table-chart').DataTable();
 
    $('input.global_filter').on( 'keyup click', function () {
        filterGlobal();
    } );
	
	 $('input.column_filter').on( 'keyup click', function () {
        filterColumn( $(this).parents('tr').attr('data-column') );
    } );
	
} );
	
	
	//custom refresh function, see http://stackoverflow.com/questions/21113513/dcjs-reorder-datatable-by-column/21116676#21116676
	function RefreshTable() {
            dc.events.trigger(function () {
                alldata = tableDimension.top(Infinity);
                datatable.fnClearTable();
                datatable.fnAddData(alldata);
                datatable.fnDraw();
            });
        }
	
	//call RefreshTable when dc-charts are filtered
	for (var i = 0; i < dc.chartRegistry.list().length; i++) {
		var chartI = dc.chartRegistry.list()[i];
		chartI.on("filtered", RefreshTable);
	}
	
	//filter all charts when using the datatables search box
	 $(":input").on('keyup',function(){
		text_filter(tableDimension, this.value);//cities is the dimension for the data table

	function text_filter(dim,q){
		 if (q!='') {
			dim.filter(function(d){
				return d.indexOf (q.toLowerCase()) !== -1;
			});
		} else {
			dim.filterAll();
			}
		RefreshTable();
		dc.redrawAll();}
	});

	//sbuDim   = xf.dimension(function(d) {return d['SBU'];}),
meanAnnualSalGroup = xf.groupAll().reduce(
          function (p, v) {
              ++p.n;
              p.tot += parseFloat(v['Annual Salary FTE (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function (p, v) {
              --p.n;
              p.tot -= parseFloat(v['Annual Salary FTE (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function () { return {n:0,tot:0}; }
      );
  var average_annualsal = function(d) {
      return d.n > 0 ? d.tot / d.n : 0;
  };
  var expCount_annualsal = function(d) {
      return d.n;
  };

boxNDannualsal
      .formatNumber(d3.format('$,.0f'))//formatAbbreviation)
      .valueAccessor(function(p) {return p.tot;})
      .group(meanAnnualSalGroup);
	  
boxNDempcount
      .formatNumber(d3.format(",.f"))
      .valueAccessor(expCount_annualsal)
      .group(meanAnnualSalGroup);
	  

/*meanMarketMedGroup = xf.groupAll().reduce(
          function (p, v) {
              ++p.n;
              p.tot += parseFloat(v['Market Median (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function (p, v) {
              --p.n;
              p.tot -= parseFloat(v['Market Median (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function () { return {n:0,tot:0}; }
      );
  var average_marketmed = function(d) {
      return d.n > 0 ? d.tot / d.n : 0;
  };
  var expCount_marketmed = function(d) {
      return d.n;
  };

boxNDmarketmed
      .formatNumber(d3.format("$.3s"))
      .valueAccessor(average_marketmed)
      .group(meanMarketMedGroup);
*/
 meanCompRatioGroup = xf.groupAll().reduce(
          function (p, v) {
              ++p.n;
              p.tot += parseFloat(v['CompRatio'].replace(/[^\d\.]/g,''));
              return p;
          },
          function (p, v) {
              --p.n;
              p.tot -= parseFloat(v['CompRatio'].replace(/[^\d\.]/g,''));
              return p;
          },
          function () { return {n:0,tot:0}; }
      );
  var average_compratio = function(d) {
      return d.n > 0 ? d.tot / d.n : 0;
  };
  var empCount_compratio = function(d) {
      return d.n;
  };

boxNDcompratio
      .formatNumber(d3.format(".2f"))
      .valueAccessor(average_compratio)
      .group(meanCompRatioGroup);

sumcostMarketUSDGroup = xf.groupAll().reduce(
          function (p, v) {
              ++p.n;
              p.tot += parseFloat(v['Cost to Bring to Market Median (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function (p, v) {
              --p.n;
              p.tot -= parseFloat(v['Cost to Bring to Market Median (USD)'].replace(/[^\d\.]/g,''));
              return p;
          },
          function () { return {n:0,tot:0}; }
      );

var costMarketUSD = function(d) {return d.tot;};

	  
boxNDmarketcost
	.formatNumber(d3.format('$,.3s'))
	.valueAccessor(costMarketUSD)
	.group(sumcostMarketUSDGroup);

  
	//initial table refresh
	RefreshTable();
	//initialize other charts
	dc.renderAll();
});

</script>
</body>
</html>
